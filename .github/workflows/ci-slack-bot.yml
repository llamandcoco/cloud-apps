name: CI - Slack Bot

on:
  push:
    branches: [main, develop]
    paths:
      - 'applications/chatops/slack-bot/**'
      - '.github/workflows/ci-slack-bot.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'applications/chatops/slack-bot/**'
  workflow_dispatch:

env:
  APP_PATH: applications/chatops/slack-bot
  NODE_VERSION: '20'

jobs:
  # Job 1: Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_PATH }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.APP_PATH }}
        run: npm ci

      - name: Run ESLint
        working-directory: ${{ env.APP_PATH }}
        run: npm run lint

      - name: Run TypeScript type check
        working-directory: ${{ env.APP_PATH }}
        run: npm run type-check

  # Job 2: Unit Tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_PATH }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.APP_PATH }}
        run: npm ci

      - name: Run tests with coverage
        working-directory: ${{ env.APP_PATH }}
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ${{ env.APP_PATH }}/coverage/coverage-final.json
          flags: slack-bot
          name: slack-bot-coverage

  # Job 3: Build Lambda Packages
  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_PATH }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.APP_PATH }}
        run: npm ci

      - name: Build TypeScript
        working-directory: ${{ env.APP_PATH }}
        run: npm run build

      - name: Package Lambda - Router
        working-directory: ${{ env.APP_PATH }}
        run: |
          mkdir -p dist/router
          cp -r build/router/* dist/router/
          cp package.json package-lock.json dist/router/
          cd dist/router
          npm ci --production
          zip -r ../router.zip .

      - name: Package Lambda - Echo Worker
        working-directory: ${{ env.APP_PATH }}
        run: |
          mkdir -p dist/workers/echo
          cp -r build/workers/echo/* dist/workers/echo/
          cp package.json package-lock.json dist/workers/echo/
          cd dist/workers/echo
          npm ci --production
          zip -r ../../echo-worker.zip .

      - name: Package Lambda - Deploy Worker
        working-directory: ${{ env.APP_PATH }}
        run: |
          mkdir -p dist/workers/deploy
          cp -r build/workers/deploy/* dist/workers/deploy/
          cp package.json package-lock.json dist/workers/deploy/
          cd dist/workers/deploy
          npm ci --production
          zip -r ../../deploy-worker.zip .

      - name: Package Lambda - Status Worker
        working-directory: ${{ env.APP_PATH }}
        run: |
          mkdir -p dist/workers/status
          cp -r build/workers/status/* dist/workers/status/
          cp package.json package-lock.json dist/workers/status/
          cd dist/workers/status
          npm ci --production
          zip -r ../../status-worker.zip .

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: lambda-packages
          path: |
            ${{ env.APP_PATH }}/dist/*.zip
          retention-days: 7

      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ACTIONS_DEPLOY_ROLE_ARN }}
          aws-region: ca-central-1

      - name: Upload to S3
        if: github.ref == 'refs/heads/main'
        working-directory: ${{ env.APP_PATH }}
        run: |
          aws s3 cp dist/router.zip s3://laco-lambda-artifacts/slack-bot/${{ github.sha }}/router.zip
          aws s3 cp dist/echo-worker.zip s3://laco-lambda-artifacts/slack-bot/${{ github.sha }}/echo-worker.zip
          aws s3 cp dist/deploy-worker.zip s3://laco-lambda-artifacts/slack-bot/${{ github.sha }}/deploy-worker.zip
          aws s3 cp dist/status-worker.zip s3://laco-lambda-artifacts/slack-bot/${{ github.sha }}/status-worker.zip

      - name: Create deployment marker
        if: github.ref == 'refs/heads/main'
        run: |
          echo "${{ github.sha }}" > deployment-ready.txt

      - name: Upload deployment marker
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v6
        with:
          name: deployment-marker
          path: deployment-ready.txt
          retention-days: 1
