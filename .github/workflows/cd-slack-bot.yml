name: CD - Slack Bot

on:
  workflow_run:
    workflows: ["CI - Slack Bot"]
    types:
      - completed
    branches: [main]

env:
  TERRAFORM_VERSION: '1.6.0'
  TERRAGRUNT_VERSION: '0.54.0'

jobs:
  deploy:
    name: Deploy to Platform
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout cloud-sandbox
        uses: actions/checkout@v4
        with:
          repository: llamandcoco/cloud-sandbox
          token: ${{ secrets.GH_PAT }}
          path: cloud-sandbox

      - name: Download deployment marker
        uses: actions/download-artifact@v4
        with:
          name: deployment-marker
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get Git SHA
        id: sha
        run: |
          SHA=$(cat deployment-ready.txt)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Deploying commit: $SHA"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ACTIONS_DEPLOY_ROLE_ARN }}
          aws-region: ca-central-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terragrunt
        run: |
          wget https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Update Lambda source paths
        working-directory: cloud-sandbox/aws/10-plt
        run: |
          # Update terragrunt.hcl files to use S3 artifacts
          export GIT_SHA="${{ steps.sha.outputs.sha }}"

          # Router
          sed -i "s|source_path = .*|source_path = \"s3://laco-lambda-artifacts/slack-bot/${GIT_SHA}/router.zip\"|" \
            slack-router/terragrunt.hcl

          # Workers
          sed -i "s|source_path = .*|source_path = \"s3://laco-lambda-artifacts/slack-bot/${GIT_SHA}/echo-worker.zip\"|" \
            chatbot-echo-worker/terragrunt.hcl

          sed -i "s|source_path = .*|source_path = \"s3://laco-lambda-artifacts/slack-bot/${GIT_SHA}/deploy-worker.zip\"|" \
            chatbot-deploy-worker/terragrunt.hcl

          sed -i "s|source_path = .*|source_path = \"s3://laco-lambda-artifacts/slack-bot/${GIT_SHA}/status-worker.zip\"|" \
            chatbot-status-worker/terragrunt.hcl

      - name: Deploy SQS Queues
        working-directory: cloud-sandbox/aws/10-plt
        run: |
          cd chatbot-echo-sqs && terragrunt apply -auto-approve
          cd ../chatbot-deploy-sqs && terragrunt apply -auto-approve
          cd ../chatbot-status-sqs && terragrunt apply -auto-approve

      - name: Deploy EventBridge
        working-directory: cloud-sandbox/aws/10-plt/chatbot-eventbridge
        run: terragrunt apply -auto-approve

      - name: Deploy Router Lambda
        working-directory: cloud-sandbox/aws/10-plt/slack-router
        run: terragrunt apply -auto-approve

      - name: Deploy Worker Lambdas
        working-directory: cloud-sandbox/aws/10-plt
        run: |
          cd chatbot-echo-worker && terragrunt apply -auto-approve
          cd ../chatbot-deploy-worker && terragrunt apply -auto-approve
          cd ../chatbot-status-worker && terragrunt apply -auto-approve

      - name: Get API Gateway URL
        id: api_url
        working-directory: cloud-sandbox/aws/10-plt/slack-router
        run: |
          URL=$(terragrunt output -raw api_gateway_url)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "API Gateway URL: $URL"

      - name: Post deployment notification
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "API Gateway URL: ${{ steps.api_url.outputs.url }}"
          echo "Git SHA: ${{ steps.sha.outputs.sha }}"

      - name: Post failure notification
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check logs for details."
